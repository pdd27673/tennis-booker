version: '3.8'

services:
  # Database services
  mongodb:
    image: mongo:6.0
    container_name: tennis-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=${MONGO_ROOT_USERNAME:-admin}
      - MONGO_INITDB_ROOT_PASSWORD=${MONGO_ROOT_PASSWORD:-password}
    volumes:
      - mongodb_data:/data/db
    networks:
      - tennis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 30s
      timeout: 10s
      retries: 3

  redis:
    image: redis:7.0-alpine
    container_name: tennis-redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-password}
    volumes:
      - redis_data:/data
    networks:
      - tennis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Vault service for secrets management
  vault:
    image: hashicorp/vault:1.16
    container_name: tennis-vault
    volumes:
      - vault_data:/vault/data
      - ./infrastructure/vault/config:/vault/config
      - vault_logs:/vault/logs
    cap_add:
      - IPC_LOCK
    environment:
      - VAULT_ADDR=http://0.0.0.0:8200
    ports:
      - "8200:8200"
    networks:
      - tennis-network
    restart: unless-stopped
    command: server -config=/vault/config/vault.hcl
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Application services
  notification-service:
    build:
      context: .
      dockerfile: Dockerfile.notification
    container_name: tennis-notification
    environment:
      - MONGO_URI=mongodb://admin:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/tennis_booking?authSource=admin
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-password}
      - GMAIL_EMAIL=${GMAIL_EMAIL}
      - GMAIL_PASSWORD=${GMAIL_PASSWORD}
      - DB_NAME=tennis_booking
      - VAULT_ADDR=http://vault:8200
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      vault:
        condition: service_healthy
    networks:
      - tennis-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "ps", "aux", "|", "grep", "notification-service"]
      interval: 30s
      timeout: 10s
      retries: 3

  scraper-service:
    build:
      context: .
      dockerfile: Dockerfile.scraper
    container_name: tennis-scraper
    environment:
      - MONGO_URI=mongodb://admin:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/tennis_booking?authSource=admin
      - DB_NAME=tennis_booking
      - VAULT_ADDR=http://vault:8200
    depends_on:
      mongodb:
        condition: service_healthy
      vault:
        condition: service_healthy
    networks:
      - tennis-network
    restart: unless-stopped
    # Run scraper every 5 minutes
    command: >
      sh -c "
        while true; do
          python src/playwright_scraper.py --all
          echo 'Scraping cycle completed, waiting 5 minutes...'
          sleep 300
        done
      "

  # Seed services (run once)
  seed-db:
    build:
      context: .
      dockerfile: Dockerfile.notification
    container_name: tennis-seed-db
    environment:
      - MONGO_URI=mongodb://admin:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/tennis_booking?authSource=admin
      - DB_NAME=tennis_booking
      - VAULT_ADDR=http://vault:8200
    depends_on:
      mongodb:
        condition: service_healthy
      vault:
        condition: service_healthy
    networks:
      - tennis-network
    command: ["./seed-db"]
    restart: "no"

  seed-user:
    build:
      context: .
      dockerfile: Dockerfile.notification
    container_name: tennis-seed-user
    environment:
      - MONGO_URI=mongodb://admin:${MONGO_ROOT_PASSWORD:-password}@mongodb:27017/tennis_booking?authSource=admin
      - DB_NAME=tennis_booking
      - USER_EMAIL=${USER_EMAIL:-mvgnum@gmail.com}
      - VAULT_ADDR=http://vault:8200
    depends_on:
      seed-db:
        condition: service_completed_successfully
      vault:
        condition: service_healthy
    networks:
      - tennis-network
    command: ["./seed-user"]
    restart: "no"

volumes:
  mongodb_data:
  redis_data:
  vault_data:
  vault_config:
  vault_logs:

networks:
  tennis-network:
    driver: bridge 